# Socket



### I/O模型

* 共有5个，4个同步（应用进程会阻塞），1个异步（不会阻塞）。
* 信号驱动 I/O 和 非阻塞式 I/O 比较类似。第一阶段都不会阻塞，但是非阻塞式会通过周期性的轮询检查，而信号驱动只需等待一个信号通知（类似轮询和中断的区别）。
* 阻塞 I/O 和 I/O 复用比较类似。但是 I/O 复用可以做到一个进程处理多个 I/O 事件，如果还是按原来的阻塞 I/O 来实现，则需要多进程、多线程技术，维护和切换这些进程、线程的系统开销会很大。
* 异步 I/O 从请求内核缓冲区到收到内核缓冲区复制完毕的通知，这整个过程中进程都不会被阻塞。
* https://blog.csdn.net/z_ryan/article/details/80873449



### I/O复用

* select。调用select时，比较重要的参数有：readset，writeset和timeout。readset主要用于请求处理input事件，进程会上传一个数组给内核，数组里包含的是需要用到的文件描述符；writeset和readset类似，只不过用于output事件；timeout表示进程调用select允许等待的时间，超时了就不会继续等待了。内核收到select的系统调用后，最终会返回3个状态码。0表示超时，-1表示出错或者异常终止，都是失败的。只有返回正整数表示成功，正整数是就绪描述符的数量。但是，实际上我们还需要线性遍历数组readset/writeset来逐个判断该描述符是否可用。
* select存在的问题，首先是这个复制这个数组到内核的开销很大，其次select完成后还要遍历数组，效率低。另外，这个数组默认只能是1024大小的。
* poll。调用poll时，需要fds和timeout等参数。fds是一个链表，每一个元素指定了文件描述符以及事件类型events（input还是output等）等属性。我们依然需要上传这个链表给内核。poll同样会返回状态码，我们也仍然需要线性遍历链表，检查每一项的revents属性来判断描述符是否可用。
* poll和select存在的问题类似，但是它没有数量限制，并且支持更多的事件类型。
* epoll。epoll_ctl会直接注册新的文件描述符或修改文件描述符，所有的文件描述符都会被内核维护在一棵红黑树上。但已经注册过的就不会重复注册了，也就是说内核其实会自动记录请求过的文件描述符，不会像select/poll每次都重新上传再获取。也就是说一个文件描述符只会被复制一次。epoll_wait方法需要指定一个数组来存放可用的事件。同样也是返回状态码，但是不需要遍历所有需要的文件描述符（因为有些是不可用的），它会将可用的事件写入到这个数组里。
* epoll有两个工作模式：水平触发（Level Trigger）和边缘触发（Edge Trigger）。前面的select和poll都只支持LT。
  * 水平触发指epoll_wait检测到某描述符事件就绪并通知应用进程时，进程可以不立即处理该事件；在下次调用该epoll_wait时，会继续通知该事件，直到该事件被处理。epoll的默认模式。
  * 边缘触发指epoll_wait检测到某描述符事件就绪并通知应用进程时，进程必须马上处理该事件。如果不处理，下次调用epoll_wait时，不会通知此事件。边缘触发很大程度减少了epoll事件的触发次数，效率比水平触发高很多，简单说就是避免了冗余的重复通知。另外，边缘触发只支持非阻塞文件描述符。
* epoll同样没有最大连接数限制（其实有，但很大），而且能更好地支持多线程编程。
* 应用场景：
  * select适合实时性要求比较高的场景，因为超时宽容度很低，只有1ns。且可移植性很好，被广泛支持。
  * poll实时性比select差，但没有数量限制，所以除了实时性要求很高的场景，一般用poll。
  * epoll只能在Linux平台运行，适合大量描述符同时轮询的场景，因为能够有效降低复制和查找的开销。但是如果描述符经常变动，会频繁调用epoll_ctl进行系统调用，会降低CPU的使用率，不适合用epoll。



### 概念补充

* 文件描述符：指进程在PCB（进程控制块）中保存的文件描述符表中的索引，是一个整数。不能和文件指针混淆，文件指针是唯一的，而文件描述符，只是在同一个进程中表示唯一的文件；不同进程中相等的描述符，可能指向同一份文件，也可能不是同一份文件。
* 套接字（Socket）：其实除了文件描述符外，套接字也能被监听。套接字在代码中也能用一个整数来表示。而实际上它的表示方法是IP地址：端口号，用于网络中两个进程间的通信。



### 参考资料

https://www.jianshu.com/p/397449cadc9a

https://www.jianshu.com/p/dfd940e7fca2

https://blog.csdn.net/kezhi9195/article/details/92636074

[https://baike.baidu.com/item/%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/9809582](https://baike.baidu.com/item/文件描述符/9809582)

[https://baike.baidu.com/item/%E5%A5%97%E6%8E%A5%E5%AD%97/9637606?fromtitle=socket&fromid=281150&fr=aladdin](https://baike.baidu.com/item/套接字/9637606?fromtitle=socket&fromid=281150&fr=aladdin)

